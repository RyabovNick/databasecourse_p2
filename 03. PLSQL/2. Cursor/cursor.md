# Курсоры

1. Что такое курсоры?
2. Зачем нужны?
3. Как с ним работать?
4. Open, fetch, close
5. Атрибуты курсора
6. Курсор в цикле FOR
7. Where current of; for update

Все базовые операторы **DML** - это не что иное, как - да! да! "курсоры". При выполнении INSERT, UPDATE и т.д. в "глобальной системной области", (применительно к Oracle) - всегда, открывается "курсор"!

**Курсор** - это указатель на набор записей, полученный в результате выполнения связанного с ним оператора SELECT. Используя курсор, можно отдельно обрабатывать каждую строку набора данных, возвращаемого связанным с ним SQL-оператора.

1. Объявление курсора и структуры данных, в которую, будут помещены найденные строки.
2. Открытие курсора.
3. Последовательная выборка данных.
4. Закрытие курсора.

```
Полный синтаксис определения явного курсора таков:
------ CURSOR -- имя (передаваемые параметры) --- IS -----
---------------- SELECT список полей FROM таблица выбора
---------------- WHERE условия выбора в курсор -----------
```

Объявляется курсор, как и переменная в секции заголовка  
открытие курсора оператором OPEN  
выборка данных оператором FETCH  
закрытие курсора оператором CLOSE

Команды открытия курсора, выборки данных из курсора и закрытия курсора имеют следующий синтаксис:

```
OPEN имя_курсора [(параметр_1 [, параметр_2 ...])];
FETCH имя_курсора INTO переменная_список_переменных_или_запись;
CLOSE имя_курсора;
```

В момент открытия оператором OPEN курсор выполняет связанный с ним оператор SELECT. Если оператор SELECT возвращает непустой набор записей курсор автоматически указывает на первую выбранную строку. При этом, если в объявлении курсора присутствуют служебные слова FOR UPDATE, курсор блокирует указанные таблицы и/или строки.

Что же происходит когда курсор открывается? А вот, что:

1. Анализируется значение переменных привязки.
2. На основе значений переменных привязки определяется активный набор.
3. Указатель активного набора устанавливается на первую строку.

Каждая команда FETCH перемещает данные из курсора в указанные переменные, после чего перемещает указатель на следующую запись в наборе записей, возвращенным оператором SELECT. Если записей больше нет, указатель все время будет указывать на последнюю запись, а атрибуты курсора %FOUND и %NOTFOUND становятся равными, соответственно, FALSE и TRUE.

При выполнении оператора CLOSE курсор закрывается. При этом освобождаются все ресурсы, занятые во время открытия курсора, а также разблокируются таблицы и столбцы, если они были блокированы при открытии курсора.

## Атрибуты курсора

**имя_курсора%ISOPEN** Позволяет проверить, открыт ли курсор. Если курсор имя_курсора уже открыт, возвращается значение TRUE.

**имя_курсора%ROWCOUNT** Порядковый номер строки в наборе данных, на которую указывает курсор.

**имя_курсора%FOUND** Позволяет проверить, была ли успешной последняя попытка получения записи из курсора. Если запись была выбрана, возвращается значение TRUE.

**имя_курсора%NOTFOUND** Противоположен атрибуту FOUND. Если записей больше не найдено, возвращает значение TRUE.

%ROWTYPE. То есть в своей сути v_students это не просто переменная, а переменная типа "запись" и она содержит в нашем случае как бы шесть переменных, типы которых, совпадают с типами полей таблицы STUDENTS! Теперь надеюсь ясно, что за один раз в такую, переменную, можно будет поместить целую строку из таблицы STUDENTS

```
DECLARE

    -- определяем переменную отбора
    v_GR students.groups%TYPE;
    v_stud students%rowtype;

	-- определяем параметризованный курсор
	CURSOR get_students(v_GR students.groups%TYPE) IS
		SELECT * FROM students
		WHERE groups = v_GR;

BEGIN
	-- присваиваем значение
	v_GR := 4011;

	OPEN get_students(v_GR);	-- открываем курсор и передаем параметр отбора!

	FETCH get_students INTO v_stud;
	DBMS_OUTPUT.put_line('OutPut is: '||v_stud.name||' '||v_stud.surname);

	CLOSE get_students;

END;
```

Усовершенствуем

```
DECLARE

	-- определяем переменную отбора
	v_GR students.groups%TYPE;
	v_stud students%rowtype;

	-- определяем параметризованный курсор
	CURSOR get_students(v_GR students.groups%TYPE) IS
		SELECT * FROM students
		WHERE groups = v_GR;

BEGIN
	-- присваиваем значение
	v_GR := 4011;

	OPEN get_students(v_GR);	-- открываем курсор и передаем параметр отбора!

LOOP

	FETCH get_students INTO v_stud;

	Exit when get_students%notfound;
	DBMS_OUTPUT.put_line('OutPut is: '||v_stud.name||' '||v_stud.surname);
END LOOP;

	CLOSE get_students;

END;
```

Фактическая обработка записей из курсора обычно выполняется внутри цикла. При написании такого цикла обычно производится проверка, была ли найдена хотя бы одна запись. Если да, то можно продолжить обработку этой записи; в противном случае следует выйти из цикла. Пример:

Курсор вывода на экран всех имен и фамилий студентов

```
DECLARE
-- объявление курсора
CURSOR showstudents IS
select * from students;
-- объявление временной переменной для хранения текущей строки курсора
s students%ROWTYPE;
BEGIN

-- открытие курсора
OPEN showstudents;
-- выборка первой записи
FETCH showstudents INTO s;

-- продолжать цикл до тех пор, пока курсор указывает на необработанную запись
WHILE showstudents%FOUND LOOP
	dbms_output.put_line(to_char(showstudents%ROWCOUNT)||' '||s.name||' '||s.surname);
	-- выбрать следующую запись
	FETCH showstudents INTO s;
END LOOP;
END;
```

Приведенный выше пример можно реализовать другим, более кратким путем, используя курсорный цикл FOR. При этом будет осуществлять открытие, выборку и закрытие курсора без вашего участия.

Синтаксис курсорного цикла FOR имеет следующий вид:

```
FOR запись_курсора IN имя_курсора[(параметр_1 [, параметр_2 ...])] LOOP
операторы;
END LOOP;
```

Этот цикл выбирает записи из курсора в переменную типа запись*курсора. Поля записи*курсора можно использовать для доступа к данным из операторов , выполняемых в цикле. Когда все записи выбраны, цикл завершается. Для удобства, открытие и закрытие курсора происходит автоматически. Пример:

```
DECLARE
-- объявление курсора
CURSOR showstudents IS
select * from students;

BEGIN
FOR s IN showstudents LOOP
	dbms_output.put_line(to_char(showstudents%ROWCOUNT)||' '||s.name||' '||s.surname);
END LOOP;
END;
```
