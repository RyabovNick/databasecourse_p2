# NodeJS

В этой части рассказано о подключении к серверу БД и отправки запросов.

Во-первых: Необходимо [создать пользователя](https://unidb.ru) (Можно, конечно, и собственный сервер поднять)

Дальше, если это новый проект, то создаём package.json `npm init`

Установить express & mysql - второй нужен для подключения к БД

`npm install express mysql`

Установить `nodemon` - полезное расширение, которое перезагружает сервер автоматически, при поступлении каких-либо изменений (не надо нажимать ctrl+c, запускать заново)

его можно установить глобально один раз и больше не устанавливать ни в каких проектах (в классе придётся всё равно)

После установки создаётся папка node_modules, ни в коем случае не отправляйте её в репозиторий. И никуда не скидывать (это очень долго). Создайте файл .gitignore с содержанием `node_modules`

Потом, если клонируете репозиторий на другой пк, то npm install подтянет автоматически все зависимости (они указаны в файле package.json)

`npm install -g nodemon`

далее для удобства пойдём в package.json и добавим следующее:

```
"scripts": {
    "start": "nodemon index.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  }
```

Мы добавили новый скрипт, которые можно запускать командой `npm run` и название скрипт. В нашем случае: `npm run start`. Таким образом запускается сервер.

## Config

Подключиться к БД можно разными способами. Один из вариантов - создание пула подключений

Создаётся файл `config.js`

**Внимание**: в данном примере логин, пароль хранится прям в коде. Для учебных целей сойдётся, но в реальных задачах это недопустимо, никак. Кроме того, их нельзя отправлять в репозиторий.

```javascript
const mysql = require("mysql");
/**
 * Создадим pool - набор подключений.
 * Если пользователь запрашивает что-то, что требует
 * подключения к БД, то берётся одно из готовых в pool соединений
 * и оно используется для подключения, затем освобождается
 */
var pool = mysql.createPool({
  connectionLimit: 100, //максимальное количество соединений
  host: "unidb.ru", //название сервера
  port: 3306, //порт (стандартный mysql)
  user: "username", //пользователь (имя, которое указали при регистрации)
  password: "password", //пароль
  database: "schemaname" //название схемы (совпадает с пользователем, если после 30.11 создавали)
});

//Мы говорим, что этот набор можно экспортировать,
//т.е. запросить где-то в другой части программы и использовать
module.exports = pool;
```

У нас в `index.js` должна присутствовать небольшая часть кода, если нет её можно вспомнить из API/NodeAPI

Следующий код вернёт все данные из таблицы.

Обратите внимание на конструкцию типа

```javascript
(request, response) => {};
```

Это краткая запись функции, называется arrow function

Является аналогом такой записи

```javascript
function (request, response) { }
```

```javascript
const express = require("express");
const app = express();
//подключаем ранее созданный файл
const pool = require("./config");

//по заданному адресу будет выполнять подключение к БД
//и возврат клиенту всех данных из таблицы
app.route("/get").get((request, response) => {
  //берём свободное подключение
  pool.getConnection((err, connection) => {
    //если возникнет ошибка - будет выведена в консоль
    if (err) throw err;
    //делаем запрос, параметры ошибка и результат
    connection.query("Select * from tablename", (error, result) => {
      //если возникнет ошибка - будет выведена в консоль
      if (error) throw error;
      //отправить клиенту результат выполнения запроса
      response.send(result);
    });
    //Обязательно! Необходимо освободить соединение, иначе через 100 штук приложение упадёт
    connection.release();
  });
});

app.listen(8080, () => {
  console.log("Server started!");
});
```

Обратите внимание, если мы используем параметр, который должен использовать при составлении запроса, то его необходимо использовать в запросе таким образом:

```javascript
connection.query("Select * from ??", [tablename], (error, result) => {
  //если возникнет ошибка - будет выведена в консоль
  if (error) throw error;
  //отправить клиенту результат выполнения запроса
  response.send(result);
});
```

`??` - использует для экранирования такие кавычки: \`

`?` - использует для экранирования такие кавычки: '

Будьте внимательнее, в mysql используются оба варианты!

Если нужно использовать несколько параметров

```javascript
connection.query(
  "Select * from ?? where id = ?",
  [tablename, id],
  (error, result) => {
    //если возникнет ошибка - будет выведена в консоль
    if (error) throw error;
    //отправить клиенту результат выполнения запроса
    response.send(result);
  }
);
```

Можно запустить и проверить. Конечно, для запроса вам надо создать какую-то таблицу (лучше используйте animals, файл для mysql workbench лежит тут в репозитории. Добавить немного данных и сделать возможность добавить, изменить, удалить строки (кроме select).

Хочу напомнить, что ничто не помешает вам сделать insert, когда вы будете посылать get запрос, но по соглашению get - получает, post - добавляет, put - изменяет, delete - удаляет.

## CORS - Cross-Origin Resource Sharing problem

Если увидели такую проблему, она означает, что вы пытаетесь отправить запрос на тот же сервер. О проблеме можно почитать подробнее, но как её решить тут:

На серверной часте

`npm install cors`

в код добавить следующие строчки:

Подключить cors в верхней части страницы

`const cors = require('cors')`

после

`var app = express()`

добавьте

`app.use(cors())`

Проблема решится.

На клиентской части нужно использовать ссылки вида `http://localhost:8080/api`

# Обработка API с JSON

Если для POST, PUT API необходимо обрабатывать JSON, то встроенными средствами сделать не получиться. Необходимо установить `npm install body-parser`

подключить библиотеку `const bodyParser = require('body-parser')`

и использовать в приложении

```
app.use(bodyParser.urlencoded({ extended: false }))
app.use(bodyParser.json())
```
